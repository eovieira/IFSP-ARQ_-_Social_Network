<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/style.css">
    <title>
        {% if current_user_blocked %}
            Usuário não encontrado
        {% else %}
            Perfil de {{ user.username }}
        {% endif %}
    </title>
</head>

<body>
    <header>
        <div class="container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Instituto_Federal_de_S%C3%A3o_Paulo_-_Marca_Vertical_2015.svg"
                class='logo-img'>
            <p class='center-title'>
                {% if current_user_blocked %}
                    Usuário não encontrado
                {% else %}
                    Perfil de {{ user.username }}
                {% endif %}
            </p>
            <nav>
                <ul class='menu'>
                    {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('perfil', username=current_user.username) }}">
                            @{{ current_user.username.lower() }}</a>
                    </li>
                    {% if current_user.cargo == 'Administrador' %}
                    <li><a href="{{ url_for('admin_panel') }}">Admin</a></li>
                    {% endif %}
                    <li><a class="sair" href="{{ url_for('logout') }}">Sair</a></li>
                    {% else %}
                    <li><a href="{{ url_for('login') }}">Fazer login</a></li>
                    <li><a href="{{ url_for('registrar') }}">Registrar-se</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <form>
        {% if current_user_blocked %}
        <p>As informações do usuário não podem ser exibidas</p>
        {% elif current_user_is_blocking %}
            <p>Seguidores: {{ quantia_seguidores }}, Seguindo: {{ quantia_seguindo }}</p>
            <p>Você bloqueou {{ user.username }}</p>
            <a href="{{ url_for('desbloquear', username=user.username) }}"><span id="unblock">Desbloquear</span></a>
        {% else %}
            <p>Seguidores: {{ quantia_seguidores }}, Seguindo: {{ quantia_seguindo }}</p>
            {% if user.id != current_user.id %}
                {% if current_user.seguindo.filter_by(id_seguido=user.id).first() %}
                    <a href="{{ url_for('deixar_de_seguir', username=user.username) }}">Deixar de seguir</a>
                {% else %}
                    <a href="{{ url_for('seguir', username=user.username) }}">Seguir</a>
                {% endif %}
                {% if not current_user.bloqueados.filter_by(id_bloqueado=user.id).first() %}
                    <a href="{{ url_for('bloquear', username=user.username) }}"><span id="block">Bloquear</span></a>
                {% endif %}
            {% endif %}
        
            <!-- Exibir Seguindo -->
            <p>Seguindo:</p>
            <ul class="seguindo">
                {% for seguido in seguindo %}
                    <li>{{ seguido.username }}</li>
                {% endfor %}
            </ul>

            <!-- Exibir Seguidores -->
            <p>Seguidores:</p>
            <ul class="seguidores">
                {% for seguidor in seguidores %}
                    <li>{{ seguidor.username }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </form>

    {% if not current_user_blocked %}
    <div class="publicacoes">
        {% for publicacao in user.publicacoes %}
        <form>
            <p>{{ publicacao.texto }}</p>
            <p><small>Postado por: {{ publicacao.usuario.username }}</small></p>
            <p><strong>Curtidas:</strong> {{ publicacao.listar_curtidas()|join(', ') }}</p>
        
            {% set user_has_liked = false %}
            {% for curtida in publicacao.curtidas %}
                {% if curtida.usuario.id == current_user.id %}
                    {% set user_has_liked = true %}
                {% endif %}
            {% endfor %}
        
            {% if not user_has_liked %}
                <form action="{{ url_for('curtir_publicacao', publicacao_id=publicacao.id) }}" method="POST">
                    <button type="submit">Curtir</button>
                </form>
            {% else %}
                <span>Você já curtiu esta publicação</span>
            {% endif %}
        
            <!-- Exibir comentários -->
            <h4>Comentários:</h4>
            <ul>
                {% for comentario in publicacao.comentarios %}
                    <li>
                        <p>{{ comentario.texto }} - <small>{{ comentario.usuario.username }}</small></p>
                        <p><strong>Curtidas:</strong> {{ comentario.listar_curtidas()|join(', ') }}</p>
        
                        <!-- Formulário para curtir o comentário -->
                        {% if not comentario.curtidas.filter_by(id_usuario=current_user.id).first() %}
                            <form action="{{ url_for('curtir_comentario', comentario_id=comentario.id) }}" method="POST">
                                <button type="submit">Curtir</button>
                            </form>
                        {% else %}
                            <span>Você já curtiu este comentário</span>
                        {% endif %}
        
                        <!-- Exibir respostas ao comentário -->
                        <ul>
                            {% for resposta in comentario.respostas %}
                                <li>
                                    <p>{{ resposta.texto }} - <small>{{ resposta.usuario.username }}</small></p>
                                </li>
                            {% endfor %}
                        </ul>
        
                        <!-- Formulário para responder ao comentário -->
                        <form action="{{ url_for('responder_comentario', comentario_id=comentario.id) }}" method="POST">
                            <textarea name="texto" placeholder="Responda ao comentário..."></textarea>
                            <button type="submit">Responder</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        
            <!-- Formulário para comentar -->
            <form action="{{ url_for('comentar_publicacao', publicacao_id=publicacao.id) }}" method="POST">
                <textarea name="texto" placeholder="Comente sobre a publicação..."></textarea>
                <button type="submit">Comentar</button>
            </form>
        </form>
        
        {% endfor %}
    </div>
    {% endif %}
</body>

</html>
